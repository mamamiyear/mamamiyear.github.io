---
layout: 	post
title:  	"SSH登陆简析"
date:   	2017-06-29 15:34:00 +0200
author:     mamamiyear
category:   note
tag:		ssh
SN:         3
---
### 前言

SSH登陆时最常用的登陆方式，采用非对称加密的传输策略。

SSH登陆一共分为两种方式，一是口令验证登陆，也就是用户名+密码的方式登陆；二是公钥验证登陆，也就是常说的免密码登陆。

被登陆的机器称为服务器，登陆的机器称为客户端。

---

### 口令验证登陆

#### 流程

1. 客户端发起登陆请求
2. 服务器收到请求后将自己的指纹和公钥发送给客户端
3. 客户端收到指纹后进行确认或匹配
4. 客户端确认指纹后使用收到的公钥加密自己的口令，并发送加密口令和客户端公钥给服务器
5. 服务器收到加密口令后，采用对应密钥解密，得到口令明文
6. 服务器验证口令是否正确，如果正确则保存客户端公钥并建立连接并允许双向传输数据
7. 这时双方都拥有对方公钥，数据采用公钥加密传输。

#### 优点

1. 客户端可以移植，只要知道用户名和口令即可在任何地方登陆
2. 用户每次登陆均需要口令认证，可以避免他人窃取或冒用客户端电脑进行登陆

#### 缺点

1. 口令会在网络上传输，有可能受到假服务器欺骗，使得口令密码失窃
2. 在确保客户端机器安全的前提下，每次输入口令于用户而言不够方便

#### 注意点

1. 假服务器欺骗方式：客户端发起的登陆请求被劫持到假服务器，客户端不知道面对的是假服务器，导致将自己的口令密码发送给了假服务器而失窃。
2. 应对欺骗方法：为避免这种情况，第一次连接时，服务器会发送自己指纹信息给客户端，来帮助客户端确认是否登陆了正确的服务器。但一般用户也无法判断指纹是否正确以致通常会选择确认，所以效果不佳。

---

### 公钥验证登陆

#### 流程

1. 客户端提前通过其他方式将自己的公钥保存在服务器上
2. 客户端发起登陆请求并声明采用公钥验证，同时发送自己的公钥
3. 服务器收到客户端请求和公钥后对公钥进行比对
4. 若在自己的记录中找到该公钥则采用该公钥加密随机质询口令，将加密质询和自己公钥一并发送给客户端
5. 客户端收到加密质询后利用自己的密钥解密，再将质询口令用服务器公钥加密并发送回服务器
6. 服务器解密质询口令验证正确后即可建立连接并允许双向传输数据
7. 这时双方都拥有对方公钥，数据采用公钥加密传输。

#### 优点

1. 用户不用每次都输入口令密码
2. 口令密码不会在网络上传输
3. 即使受到假服务器欺骗，也不会泄露口令密码

#### 缺点

1. 用户更换客户端后必须重新将公钥放进服务器，不够灵活
2. 电脑失窃后如不及时清除服务器上存放的公钥，也会导致他人非法登陆账户

---

### 关于SSH配置的简单整理

SSH默认的信息存放地点为：

**Windows:** 

```
C:\Users\someone\.ssh
```

**Linux:**

```
/home/someone/.ssh
```

**.ssh中的内容**

1. 公钥密钥对

   公钥密钥是成对匹配出现的，例如：id_rsa和id_rsa.pub，其中id_rsa.pub就是公钥，id_rsa就是密钥。

   公钥密钥可能存在多对。

2. config

   当存在多对公钥密钥时如何确定连接时使用哪对呢，这个对应关系就在config中保存，例如

   ```
   Host github.com www.github.com
     IdentityFile /c/Users/somenoe/.ssh/163email

   Host 192.168.0.106
     IdentityFile /c/Users/somenoe/.ssh/selfkey

   Host 192.168.0.106
     IdentityFile /c/Users/somenoe/.ssh/mykey
   ```

   可以看出当访问 github.com 或者 www.github.com 时使用163email密钥对

   而访问 192.168.0.106 先查找使用selfkey，如果不存在则再查找使用mykey

3. authorized_keys

   这个文件存储着欲采用公钥验证登陆本机的客户端公钥，当客户端请求公钥验证方式登陆时，就从这个文件中查找收到的公钥，如果存在则继续后面的步骤。

4. known_hosts

   这个文件存储登陆服务器的指纹信息，也就本机尝试登陆服务器时，第一次服务器发送来的指纹信息，如果用户确认正确则放在这个文件中，下次登录该服务器时匹配该指纹以验证正确。

**Ubuntu下配置免密登陆设置**

修改ssh服务配置文件

```shell
vim /etc/ssh/sshd_config
```

将其中# Authentication:下的内容改为

```
# Authentication:
LoginGraceTime 120
PermitRootLogin prohibit-password
StrictModes yes

RSAAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile      %h/.ssh/authorized_keys
```

重启ssh服务

```sh
service ssh restart
```